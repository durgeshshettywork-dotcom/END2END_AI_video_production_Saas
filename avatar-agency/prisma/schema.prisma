// Avatar Agency Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  EDITOR
}

enum ProjectStatus {
  CREATED
  RESEARCH_IN_PROGRESS
  RESEARCH_COMPLETE
  SCRIPT_IN_PROGRESS
  SCRIPT_PENDING_APPROVAL
  SCRIPT_APPROVED
  PRODUCTION_IN_PROGRESS
  PRODUCTION_PENDING_APPROVAL
  PRODUCTION_APPROVED
  EDITING_ASSIGNED
  EDITING_IN_PROGRESS
  FINAL_REVIEW
  COMPLETED
  CANCELLED
}

enum ActivityAction {
  PROJECT_CREATED
  STATUS_CHANGED
  SCRIPT_APPROVED
  SCRIPT_REJECTED
  VIDEO_APPROVED
  VIDEO_REJECTED
  EDITOR_ASSIGNED
  FINAL_SUBMITTED
  FEEDBACK_SENT
  PROJECT_COMPLETED
  PROJECT_CANCELLED
  WEBHOOK_CALLED
  WEBHOOK_SUCCESS
  WEBHOOK_FAILED
  WEBHOOK_RETRY
}

// Models
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          UserRole  @default(EDITOR)

  // Password reset (for AUTH-04)
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Soft delete pattern
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignedProjects Project[] @relation("EditorProjects")
  activityLogs     ActivityLog[]

  // Indexes for filtering
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Client {
  id                    String    @id @default(cuid())
  name                  String
  contentNiche          String
  avatarId              String
  voiceId               String
  brandGuidelinesUrl    String?
  editingGuidelinesUrl  String?

  // Soft delete pattern
  isActive              Boolean   @default(true)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  projects Project[]

  // Indexes for searching
  @@index([name])
  @@index([isActive])
  @@map("clients")
}

model Project {
  id              String        @id @default(cuid())
  videoIdea       String
  deadline        DateTime
  status          ProjectStatus @default(CREATED)

  // Webhook data
  researchOutput  String?       @db.Text
  script          String?       @db.Text
  scriptFeedback  String?       @db.Text
  rawVideoUrl     String?
  finalVideoUrl   String?

  // Webhook status tracking
  webhookStatus   String?       // pending, success, error
  webhookError    String?       @db.Text
  lastWebhookType String?       // Which webhook was last triggered
  retryCount      Int           @default(0)

  // Workflow timestamps (for dashboard metrics)
  scriptApprovedAt  DateTime?
  videoApprovedAt   DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations with proper cascades
  clientId        String
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  editorId        String?
  editor          User?         @relation("EditorProjects", fields: [editorId], references: [id], onDelete: SetNull)

  activityLogs    ActivityLog[]

  // Indexes for filtering, sorting, and performance
  @@index([clientId])
  @@index([editorId])
  @@index([status])
  @@index([createdAt])
  @@index([deadline])
  @@index([editorId, status])  // Composite: "my pending projects"
  @@index([status, createdAt]) // Composite: "recent projects by status"
  @@map("projects")
}

model ActivityLog {
  id          String         @id @default(cuid())
  action      ActivityAction
  details     Json?
  createdAt   DateTime       @default(now())

  // Relations with proper cascades
  projectId   String
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId      String?
  user        User?          @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Indexes for querying logs
  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("activity_logs")
}

// Webhook configuration
// NOTE: Secrets should ONLY be stored in environment variables, never in the database
model WebhookConfig {
  id          String   @id @default(cuid())
  name        String   @unique  // research, scripting, optimizer, production, notification
  url         String
  isActive    Boolean  @default(true)

  // Retry configuration
  maxRetries    Int      @default(3)
  retryDelayMs  Int      @default(5000)
  timeoutMs     Int      @default(30000)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@map("webhook_configs")
}
